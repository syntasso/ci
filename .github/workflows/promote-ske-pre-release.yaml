name: Promote SKE Pre-release

on:
  workflow_dispatch:

env:
  SKE_PLATFORM_IMG: "ghcr.io/syntasso/ske-platform"
  SKE_QUICK_START_INSTALLER_IMG: "ghcr.io/syntasso/ske-quick-start-installer"

jobs:
  promote-pre-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out enterprise kratix
        uses: actions/checkout@v4
        with:
          repository: syntasso/enterprise-kratix
          ssh-key: ${{ secrets.ENTERPRISE_KRATIX_DEPLOY_KEY_READ_PUSH }}
          submodules: recursive
          fetch-depth: 0
      - name: Set env vars
        run: |
          latest_pre_release_tag=$(gh release list --json tagName --jq '[.[] | select(.tagName | match("^v"))][0].tagName')
          latest_release_tag=$(echo $latest_pre_release_tag | sed 's/-rc[0-9]*//')
          s3_latest_release_dir="s3://syntasso-enterprise-releases/ske/${latest_release_tag}/"
          echo "LATEST_PRE_RELEASE_TAG=$latest_pre_release_tag" >> "$GITHUB_ENV"
          echo "LATEST_RELEASE_TAG=$latest_release_tag" >> "$GITHUB_ENV"
          echo "S3_LATEST_RELEASE_DIR=$s3_latest_release_dir" >> "$GITHUB_ENV"
        env:
          GH_TOKEN: ${{ secrets.ENTERPRISE_KRATIX_GH_TOKEN }}
      - name: Install Docker CLI (pinned)
        run: |
          set -euo pipefail
          curl -fsSL https://download.docker.com/linux/static/stable/x86_64/docker-29.0.1.tgz -o /tmp/docker.tgz
          tar -xzf /tmp/docker.tgz -C /tmp
          sudo install -m 0755 /tmp/docker/docker /usr/local/bin/docker
          sudo ln -sf /usr/local/bin/docker /usr/bin/docker
          docker --version
      - name: Login to ghcr
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login --username syntassodev --password-stdin ghcr.io
          echo "${{ secrets.REGISTRY_SYNTASSO_TOKEN }}" | docker login --username syntassodev --password-stdin registry.syntasso.io
      - name: Debug registry.syntasso.io access
        run: |
          set -euo pipefail
          echo "REGISTRY_SYNTASSO_TOKEN length: ${#REGISTRY_SYNTASSO_TOKEN}"
          set -x
          echo "Inspect manifest (registry.syntasso.io):"
          docker buildx imagetools inspect registry.syntasso.io/syntasso/ske-platform:${{ env.LATEST_PRE_RELEASE_TAG }} || true
          echo "Pull linux/amd64 (registry.syntasso.io):"
          docker pull --platform linux/amd64 registry.syntasso.io/syntasso/ske-platform:${{ env.LATEST_PRE_RELEASE_TAG }} || true
          echo "Pull linux/arm64 (registry.syntasso.io):"
          docker pull --platform linux/arm64 registry.syntasso.io/syntasso/ske-platform:${{ env.LATEST_PRE_RELEASE_TAG }} || true
        env:
          REGISTRY_SYNTASSO_TOKEN: ${{ secrets.REGISTRY_SYNTASSO_TOKEN }}
      - name: Debug skopeo login
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y skopeo
          echo "${{ secrets.GHCR_TOKEN }}" | skopeo login -u syntassodev --password-stdin ghcr.io --debug || true
          echo "${{ secrets.REGISTRY_SYNTASSO_TOKEN }}" | skopeo login -u syntassodev --password-stdin registry.syntasso.io --debug || true
          python - <<'PY'
          import json, os
          path = os.path.expanduser("~/.docker/config.json")
          try:
            with open(path) as f:
              data = json.load(f)
            print("Docker auths:", ", ".join(sorted(data.get("auths", {}).keys())))
          except Exception as e:
            print("Docker auths: unavailable", e)
          PY
      - name: Verify SKE release does not exist
        env:
          GH_TOKEN: ${{ secrets.ENTERPRISE_KRATIX_GH_TOKEN }}
        run: |
          ./scripts/check-ske-release-does-not-exist
      - name: Verify release images
        run: |
          ./scripts/verify-images ${{ env.LATEST_PRE_RELEASE_TAG }}
      - name: Verify SBOM artifacts
        run: |
          ./scripts/verify-sboms ${{ env.LATEST_PRE_RELEASE_TAG }}
      - name: Re-tag SKE artifacts to full release
        env:
          GH_TOKEN: ${{ secrets.ENTERPRISE_KRATIX_GH_TOKEN }}
        run: |
          ./scripts/retag-ske-artifacts-to-full-release
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-west-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Create SKE release
        env:
          GH_TOKEN: ${{ secrets.ENTERPRISE_KRATIX_GH_TOKEN }}
        run: |
          export TAG=${LATEST_RELEASE_TAG}
          ./scripts/create-release
      - name: Generate changelog
        env:
          GH_TOKEN: ${{ secrets.ENTERPRISE_KRATIX_GH_TOKEN }}
        run: |
          git fetch --tags
          ./scripts/generate-changelog
          changelog=$(cat final-changelog.md)
          echo "$changelog" >> "$GITHUB_STEP_SUMMARY"
