name: Create SKE Pre-release

on:
  workflow_dispatch:
    inputs:
      ssh_session:
        type: boolean
        description: 'Run the build with tmate debugging.'
        required: false
        default: false

jobs:
  create-pre-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out enterprise kratix
        uses: actions/checkout@v4
        with:
          repository: syntasso/enterprise-kratix
          ssh-key: ${{ secrets.ENTERPRISE_KRATIX_DEPLOY_KEY_READ_PUSH }}
          ref: ${{ github.event.inputs.ske_sha }}
          submodules: recursive
      - name: Start tmate ssh debugging session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.ssh_session }}
        with:
          limit-access-to-actor: true
          detached: true
      - name: Generate changelog
        run: |
          git fetch --tags
          changelog=$(LATEST_RELEASE_TAG=v0.28.0-rc3 ./scripts/generate-changelog)
          echo "$changelog" >> "$GITHUB_STEP_SUMMARY"
        env:
          GH_TOKEN: ${{ secrets.ENTERPRISE_KRATIX_GH_TOKEN }}