name: 'Setup Common Environment'
description: 'Setup environment with repository checkout, tools installation, and tmate debugging'

inputs:
  repository:
    description: 'Repository to checkout (e.g., syntasso/kratix)'
    required: false
    default: ''
  ref:
    description: 'Reference to checkout (commit sha, branch, etc.)'
    required: false
    default: ''
  path:
    description: 'Path to checkout repository into'
    required: false
    default: ''
  ssh_key:
    description: 'SSH key for private repository access'
    required: false
    default: ''
  submodules:
    description: 'Whether to checkout submodules'
    required: false
    default: 'false'
  submodule_repository:
    description: 'Submodule repository to checkout (e.g., syntasso/kratix)'
    required: false
    default: ''
  submodule_ref:
    description: 'Reference to checkout for submodule (commit sha, branch, etc.)'
    required: false
    default: ''
  submodule_path:
    description: 'Path to checkout submodule repository into'
    required: false
    default: ''
  ssh_session:
    description: 'Whether to enable tmate ssh debugging session (true/false)'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Checkout parameterized repository
      if: "${{ inputs.repository != '' }}"
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}
        path: ${{ inputs.path }}
        ssh-key: ${{ inputs.ssh_key }}
        submodules: ${{ inputs.submodules }}

    - name: Checkout submodule repository
      if: "${{ inputs.submodule_repository != '' && inputs.submodule_ref != '' }}"
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.submodule_repository }}
        ref: ${{ inputs.submodule_ref }}
        path: ${{ inputs.submodule_path }}

    - name: Start tmate ssh debugging session
      if: "${{ inputs.ssh_session == 'true' }}"
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
        detached: true

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.24
        check-latest: true
        cache-dependency-path: ${{ inputs.path }}/go.sum

    - name: Setup Docker Buildx
      id: setup-buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        use: true

    - name: Restore BuildKit cache
      id: cache
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/buildkit-cache
        key: ${{ runner.os }}-buildkit-${{ github.head_ref || github.ref_name }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildkit-${{ github.head_ref || github.ref_name }}-

    - name: Restore Docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        builder: ${{ steps.setup-buildx.outputs.name }}
        cache-dir: ${{ runner.temp }}/buildkit-cache
        dockerfile: ${{ inputs.path }}/Dockerfile
        skip-extraction: ${{ steps.cache.outputs.cache-hit }}

    - name: Export BuildKit cache dir
      run: echo "BUILDKIT_CACHE_DIR=${RUNNER_TEMP}/buildkit-cache" >> $GITHUB_ENV
      shell: bash

    - name: Install Kind
      uses: helm/kind-action@v1
      with:
        install_only: true
        version: v0.29.0

    - name: Setup Flux CLI
      uses: fluxcd/flux2/action@main
      with:
        version: '2.4.0' 